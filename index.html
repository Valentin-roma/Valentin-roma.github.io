<html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Machines</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <style>
        body {
            padding-bottom: 50px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-responsive {
            margin-top: 20px;
        }
        #reader {
            min-height: 300px;
            border: 2px dashed #ccc;
            margin-bottom: 15px;
        }
        .qr-code-img {
            max-width: 200px;
            height: auto;
        }
        .hidden {
            display: none;
        }
        .alert {
            transition: opacity 0.5s ease-out;
        }
	.table-danger {
    		background-color: #ffdddd !important; /* Rouge très clair */
	}

	.text-danger.fw-bold {
    		font-weight: bold;
    		color: #dc3545 !important; /* Rouge Bootstrap */
	}
	#unit-edit-view {
  		position: fixed;
  		top: 0;
  		left: 0;
  		z-index: 1060;
  		background-color: white;
  		width: 100vw;
  		height: 100vh;
  		overflow: auto;
	}
	html, body {
    		height: 100%;
	}

	body {
    		display: flex;
    		flex-direction: column;
	}

	.container {
    		flex: 1;
	}

    </style>
</head>
<body class="" style="">
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container">
	    <a class="navbar-brand" href="#" onclick="showView('home')">Gestion Machines</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-expanded="true">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="navbar-collapse collapse show" id="navbarNav" style="">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('add-machine')">Ajouter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('list-machines')">Liste</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('scan')">Scanner</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('cvi')">CVI</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('export')">Sauvegarde</a>
		    </li>
		   <li class="nav-item">
    			<a class="nav-link" href="#" onclick="showView('logs')">Logs</a>
		   </li>

                </ul>
            </div>

        </div>
    </nav>



    <div class="container mt-4">
        <div id="alert-placeholder"></div>

        <div id="home-view" class="view hidden">
            <h2>Gestionnaire de machines</h2>
            <div class="d-grid gap-2">
                <button class="btn btn-danger" onclick="showView('add-machine')">Ajouter une machine</button>
                <button class="btn btn-secondary" onclick="showView('list-machines')">Voir l'inventaire</button>
                <button class="btn btn-secondary" onclick="showView('scan')">Scanner un produit</button>
            </div>
        </div>

        <div id="add-machine-view" class="view hidden">
            <h2>Ajouter une machine</h2>
            <form id="add-machine-form">
                <div class="mb-3">
                    <label for="marque" class="form-label">Marque</label>
                    <input type="text" class="form-control" id="marque" required="">
                </div>
                <div class="mb-3">
                    <label for="model" class="form-label">Modèle</label>
                    <input type="text" class="form-control" id="model" required="">
                </div>
                <div class="mb-3">
                    <label for="quantite" class="form-label">Quantité</label>
                    <input type="number" class="form-control" id="quantite" min="1" value="1" required="">
                </div>
		<div class="mb-3">
			<label for="description" class="form-label">Description</label>
			<textarea class="form-control" id="description" rows="3"></textarea>
		</div>
		<div id="unit-fields-container"></div>

                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="showView('home')">Annuler</button>
		<button type="button" class="btn btn-success" onclick="printQRCode()">Imprimer le QR</button>
            </form>
        </div>
        <div id="list-machines-view" class="view hidden">
            <h2>Inventaire des Machines</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th onclick="sortMachinesby('marque',this)">Marque<span class="chevron"></span></th>
			    <th onclick="sortMachinesby('model',this)">Modèle<span class="chevron"></span></th>
                            <th>Quantité</th>
			    <th onclick="sortMachinesby('emplacement',this)">Emplacement Global<span class="chevron"></span></th>
                            <th>Actions</th>

                        </tr>
                    </thead>
                    <tbody id="machines-table-body"><tr>
                    <td>Tektronix</td>
                    <td>r</td>
                    <td>1</td>
                    <td>B-2 + B-7 + Bonjour</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showProductModal(0)">
                            Modifier
                        </button>
                    </td>
                </tr></tbody>
                </table>
            </div>
            <button class="btn btn-secondary" onclick="showView('home')">Retour</button>
        </div>

        <div id="scan-view" class="view hidden">
            <h2>Scanner un produit</h2>
            <div class="card">
                <div class="card-body">
                    <div id="reader" style="position: relative; padding: 0px; border: none;"></div>
		    <video id="video" autoplay playsinline></video>
    		    <canvas id="canvas" hidden></canvas>

    		    <div id="result">En attente de scan...</div>
		    <div class="text-center mt-3">
                        <button id="startButton" class="btn btn-primary">Démarrer le scan</button>
                        <button id="stopButton" class="btn btn-danger" disabled="">Arrêter</button>
                    </div>
                </div>
            </div>
            <div class="card mt-3">
  			<div class="card-body">
    				<h5>Recherche manuelle</h5>
    				<div class="row g-2 align-items-center">
      					<div class="col-md-4">
        					<select class="form-select" id="search-type">
          						<option value="model">Marque / Modèle</option>
          						<option value="numserie">Numéro de série</option>
        					</select>
      					</div>
      					<div class="col-md-6">
        					<input type="text" class="form-control" id="manual-search" placeholder="Rechercher une marque/modèle ou un numéro de série">
      					</div>
      					<div class="col-md-2 d-grid">
        					<button class="btn btn-primary" type="button" onclick="manualSearch()">Rechercher</button>
      					</div>
    				</div>
    				<div id="search-results" class="mt-4"></div>
  			</div>
		</div>
            <button class="btn btn-secondary mt-3" onclick="showView('home')">Retour</button>

        </div>
	<div id="unit-detail-view" class="view hidden">
    		<h2>Détail de l’unité</h2>
    		<div id="unit-detail-content" class="border rounded p-3 bg-light"></div>
    		<button class="btn btn-secondary mt-3" onclick="showView('home')">Retour</button>
	</div>
        <div id="cvi-view" class="view">
            <h2>Gestion des CVI</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Marque</th>
			    <th>Modèle</th>
			    <th>Numéro de série</th>
			    <th>Emplacement</th>
                            <th>Date du CVI</th>
                        </tr>

                    </thead>
                    <tbody id="cvi-table-body"><tr><td colspan="6" class="text-center">Aucune machine avec CVI</td></tr></tbody>
                </table>
            </div>
            <button class="btn btn-secondary" onclick="showView('home')">Retour</button>
        </div>
    </div>
	<footer class="text-center mt-5 py-3 bg-light text-muted" style="font-size: 0.9rem;">
    		Conçu par Valentin Roy-Mamer avec l'aide de Ryan ALONZO ©2025
	</footer>
    <div id="export-view" class="view hidden">
		  <div class="card shadow mx-auto mt-4" style="max-width: 600px;">
	            <div class="card-body">
			<h2>Gérer une sauvegarde</h2>
                	<div class="d-grid gap-2">
				<h5>Exporter </h5>
                    		<button class="btn btn-danger" onclick="exportData()">Exporter JSON</button>
			
				<button class="btn btn-danger" onclick="exportDataToExcel()">Exporter EXCEL</button>
                
				<h5>Importer un fichier JSON</h5>
				<input type="file" id="import-file" class="form-control mt-2" onchange="importData()">
                
				<h5>Importer un fichier EXCEL</h5>
				<input type="file" id="import-excel-file" class="form-control" accept=".xlsx, .xls, .json" onchange="importDataFromExcel()">

			</div>	
		      </div>
		  </div>
  		  <div class="card shadow mx-auto mt-4" style="max-width: 600px;">
	            <div class="card-body">
                	<div class="d-grid gap-2">
				<h5> Sauvegarde  </h5>
                    		<button class="btn btn-danger" onclick="envoyerVersGitHub(machines)">Sauvegarde</button>
				<button class="btn btn-danger" onclick="chargerMachinesDepuisGitHub()">Charger</button>
			               
			</div>	
		      </div>
		  </div>
	</div>		

	<div id="logs-view" class="view hidden">
    		<h2>Journal des actions</h2>
    		<div class="table-responsive">
        		<table class="table table-bordered">
            			<thead>
                			<tr>
                    				<th>Date</th>
                    				<th>Type</th>
                    				<th>Message</th>	
					</tr>
            			</thead>
            			<tbody id="logs-table-body"></tbody>
        		</table>
    		</div>
    		<button class="btn btn-secondary" onclick="clearLogs()">Vider les logs</button>
    		<button class="btn btn-secondary" onclick="showView('home')">Retour</button>
	</div>


    <div class="modal fade" id="productModal" tabindex="-1" style="display: none;" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Fiche Produit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="product-modal-body">
                <div class="mb-3">
                    <label class="form-label">Marque</label>
                    <input type="text" class="form-control" id="modal-marque">
                </div>
                <div class="mb-3">
                    <label class="form-label">Modèle</label>
                    <input type="text" class="form-control" id="modal-model">
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantité</label>
                    <input type="number" class="form-control" id="modal-quantity" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="modal-description">
                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-primary" onclick="updateProduct()">Enregistrer</button>
                    <button class="btn btn-danger" onclick="deleteMachine(0)">Supprimer</button>
                </div>
            </div>
            </div>
        </div>
     </div>

	<div id="unit-edit-view" class="view hidden">
	   <div class="card shadow mx-auto mt-4" style="max-width: 600px;">
	      <div class="card-body">
    		<h2>Modifier l’unité</h2>
    		<form id="unit-edit-form">
        		<div class="mb-3">
            			<label class="form-label">Marque</label>
           	 		<input type="text" class="form-control" id="edit-unit-marque" required>
        		</div>
        		<div class="mb-3">
            			<label class="form-label">Modèle</label>
            			<input type="text" class="form-control" id="edit-unit-modele" required>
        		</div>
        		<div class="mb-3">
            			<label class="form-label">Numéro de série</label>
            			<input type="text" class="form-control" id="edit-unit-numserie" required>
        		</div>
        		<div class="mb-3">
            			<label class="form-label">Emplacement</label>
            			<input type="text" class="form-control" id="edit-unit-position" required>
        		</div>
        		<div class="mb-3">
            			<label class="form-label">CVI</label>
            			<select class="form-select" id="edit-unit-cvi">
                			<option value="non">Non</option>
                			<option value="oui">Oui</option>
            			</select>
        		</div>
        		<div class="mb-3" id="edit-unit-cvi-date-container">
            			<label class="form-label">Date fin CVI</label>
            			<input type="date" class="form-control" id="edit-unit-date-cvi">
        		</div>
       			<button type="submit" class="btn btn-primary">Enregistrer</button>
			<button type="button" class="btn btn-danger" id="delete-unit-button">Supprimer</button>
			<button type="button" class="btn btn-success" onclick="imprimerQRCodeUnite()">Imprimer le QR</button>
       			<button type="button" class="btn btn-secondary" onclick="showView('scan')">Annuler</button>


		</form>
	     </div>
	  </div>
	</div>

    </div>
    <script>
        let machines = JSON.parse(localStorage.getItem('machines')) || [];
        let html5QrcodeScanner = null;
        let currentScanIndex = null;

	document.addEventListener('DOMContentLoaded', async function () {
    		await chargerMachinesDepuisGitHub();
    		showView('home');
    		document.getElementById('add-machine-form').addEventListener('submit', addMachine);
    		document.getElementById('etatcvi')?.addEventListener('change', toggleCVIDate);
	});


        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            
            if (viewName === 'list-machines') updateInventory();
            if (viewName === 'cvi') updateCVIList();
	    if (viewName === 'add-machine') {document.getElementById('quantite').dispatchEvent(new Event('input'));};
	    if (viewName === 'logs') updateLogsView();
	}

        function addMachine(e) {
            e.preventDefault();
            
            const marque = document.getElementById('marque').value.trim();
            const model = document.getElementById('model').value.trim();
	    const description = document.getElementById('description').value.trim();
            const quantite = parseInt(document.getElementById('quantite').value);
            const etatcvi = 'non';
            const dateFinCVI = null;

            if (!marque || !model || isNaN(quantite) || (etatcvi === 'oui' && !dateFinCVI)) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'danger');
                return;
            }


	    const existingIndex = machines.findIndex(m => 
    		m.marque && m.model &&
    		m.marque.toLowerCase() === marque.toLowerCase() && 
    		m.model.toLowerCase() === model.toLowerCase() 
            );

            if (existingIndex !== -1) {
                machines[existingIndex].quantite += quantite;
		const newUnits = [];
    		for (let i = 0; i < quantite; i++) {
        		newUnits.push({
            			numserie: document.getElementById(`numserie-${i}`).value.trim(),
				position:document.getElementById(`position-${i}`).value.trim(),
            			etatcvi: document.getElementById(`etatcvi-${i}`).value,
            			dateFinCVI: document.getElementById(`etatcvi-${i}`).value === 'oui' 
                      			? document.getElementById(`dateFinCVI-${i}`).value 
                      			: null
        		});
    		}
    
    
    		machines[existingIndex].unites = [...(machines[existingIndex].unites || []), ...newUnits];
		const allPositions = machines[existingIndex].unites.map(u => u.position?.trim()).filter(pos => pos);
			machines[existingIndex].emplacement = [...new Set(allPositions)].join(' + ');
    
                if (etatcvi === 'oui') {
                    machines[existingIndex].etatcvi = 'oui';
                    machines[existingIndex].dateFinCVI = dateFinCVI;
                }
                showAlert('Quantité mise à jour pour ce modèle', 'success');
            } else {
		const newUnits = [];
		for (let i = 0; i < quantite; i++) {
    			newUnits.push({
        			numserie: document.getElementById(`numserie-${i}`).value.trim(),
        			position: document.getElementById(`position-${i}`).value.trim(),
        			etatcvi: document.getElementById(`etatcvi-${i}`).value,
        			dateFinCVI: document.getElementById(`etatcvi-${i}`).value === 'oui' 
            				? document.getElementById(`dateFinCVI-${i}`).value 
            				: null
    			});
		}


		const uniquePositions = [...new Set(newUnits
    			.map(u => u.position?.trim())
    			.filter(pos => pos))];
		const emplacementGlobal = uniquePositions.join(' + ');
                machines.push({
                    marque: marque,
                    model: model,
                    quantite,
		    emplacement:emplacementGlobal,
		    description:description,
		    unites: Array.from({ length: quantite }, (_, i) => ({
    			numserie: document.getElementById(`numserie-${i}`).value.trim(),
			position: document.getElementById(`position-${i}`).value.trim(),
			etatcvi: document.getElementById(`etatcvi-${i}`).value,
    			dateFinCVI: document.getElementById(`etatcvi-${i}`).value === 'oui' ? document.getElementById(`dateFinCVI-${i}`).value : null
			})),
                    createdAt: new Date().toISOString()
                });
		logAction("ajout", `${machine.marque} ${machine.model} ajouté au stock`, {
    			marque: machine.marque,
    			model: machine.model,
		});
                showAlert('Nouveau modèle ajouté', 'success');
            }
		
            saveMachines();
            showView('list-machines');
        }
	
	document.getElementById('quantite').addEventListener('input', function () {
    		const count = parseInt(this.value);
    		const container = document.getElementById('unit-fields-container');
    		container.innerHTML = ''; 

    		if (isNaN(count) || count < 1) return;

    		for (let i = 0; i < count; i++) {
        		container.innerHTML += `
        		<div class="card mb-3 shadow-sm">
                		<div class="card-header bg-light">
                    			<strong>Unité ${i + 1}</strong>
                		</div>
               			<div class="card-body">
                    			<div class="row g-2">
                        			<div class="col-md-4">
                           				<label class="form-label">N° de série</label>
                            				<input type="text" class="form-control" id="numserie-${i}" >
                        			</div>
                        			<div class="col-md-4">
                           				<label class="form-label">Emplacement</label>
                            				<input type="text" class="form-control" id="position-${i}" >
                        			</div>
                        			<div class="col-md-4">
                            				<label class="form-label">CVI</label>
                            				<select class="form-select" id="etatcvi-${i}">
                                				<option value="non">Non</option>
                                				<option value="oui">Oui</option>
                            				</select>
                        			</div>
                        			<div class="col-md-4">
                            				<label class="form-label">Date fin CVI</label>
                            				<input type="date" class="form-control" id="dateFinCVI-${i}" >
                        			</div>
                    			</div>
                		</div>
            		</div>
            		`;
        	}

    	});

	function updateInventory() {
    		const tbody = document.getElementById('machines-table-body');
    		tbody.innerHTML = '';

    		if (machines.length === 0) {
        		tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune machine enregistrée</td></tr>';
        		return;
    		}
		
    		machines.forEach((machine, index) => {
        		const tr = document.createElement('tr');
			const newUnits = [];
			for (let i = 0; i < quantite; i++) {
    				newUnits.push({
        				numserie: document.getElementById(`numserie-${i}`).value.trim(),
        				position: document.getElementById(`position-${i}`).value.trim(),
        				etatcvi: document.getElementById(`etatcvi-${i}`).value,
        				dateFinCVI: document.getElementById(`etatcvi-${i}`).value === 'oui' 
            					? document.getElementById(`dateFinCVI-${i}`).value 
            					: null
    				});
			}	
		

        		tr.innerHTML = `
            			<td>${machine.marque}</td>
            			<td>${machine.model}</td>
            			<td>${machine.quantite}</td>
            			<td>${machine.emplacement}</td>
	       			<td>
    					<button class="btn btn-primary" onclick="showProductModal(${index})">Voir plus</button>
    					<button class="btn btn-secondary" onclick="toggleUnitDetails('units-${index}')">Unités</button>
            			</td>
        		`;
        		tbody.appendChild(tr);

        		const unitTr = document.createElement('tr');
        		unitTr.innerHTML = `
            			<td colspan="6" id="units-${index}" style="display: none;">
                			<div class="p-2 border rounded mt-2 bg-light">
                    				${generateUnitFields(machine, index)}
						<div class="d-flex justify-content-between mt-2">
                    					<button class="btn btn-success btn-sm mt-2" onclick="saveUnitDetails(${index})">
                        					Enregistrer les unités
                    					</button>
							<button class="btn btn-sm btn-outline-primary" onclick="addUnit(${index})">Ajouter une unité</button>
						</div>
                			</div>
           			 </td>
        		`;
       			tbody.appendChild(unitTr);
    		});
	}

	function addUnit(index) {
    		const machine = machines[index];
    		machine.unites = machine.unites || [];

    		machine.unites.push({
        		numserie: '',
			position:'',
        		etatcvi: 'non',
        		dateFinCVI: ''
    		});

    		machine.quantite = machine.unites.length;

    		saveMachines();
		
    		updateInventory();
    		updateCVIList();
		logAction("ajout", `Nouvelle unité ajoutée à ${machine.marque} ${machine.model} ${unit.numserie}`, {
    			index,
    			nouvelleUnite: machine.unites[machine.unites.length - 1]
		});
    		showAlert("Une unité a été ajoutée", "success");
    		document.getElementById(`units-${index}`).style.display = 'block';
	}

	function toggleUnitDetails(id) {
    		const container = document.getElementById(id);
		container.style.display = container.style.display === 'none' ? 'block' : 'none';
	}


	function generateUnitFields(machine, index) {
    		const unites = machine.unites || [];
    		let html = '';

    		for (let i = 0; i < machine.quantite; i++) {
        		const unit = unites[i] || { numserie: '',position:'', etatcvi: 'non', dateFinCVI: '' };
        		const qrId = `qr-unit-${index}-${i}`;
        		html += `
           	 		<div class="border p-2 mb-2 rounded">
               				 <strong>Unité ${i + 1}</strong>
                			 <div class="row">
                    			 	<div class="col-md-4">
                        				<label>Numéro de série</label>
                        				<input type="text" class="form-control" id="unit-${index}-${i}-numserie" value="${unit.numserie}">
                    				</div>
                    			 	<div class="col-md-4">
                        				<label>Emplacement</label>
                        				<input type="text" class="form-control" id="unit-${index}-${i}-position" value="${unit.position}">
                    				</div>

                    				<div class="col-md-3">
                        				<label>CVI</label>
                        				<select class="form-select" id="unit-${index}-${i}-etatcvi">
                            					<option value="non" ${unit.etatcvi === 'non' ? 'selected' : ''}>Non</option>
                            					<option value="oui" ${unit.etatcvi === 'oui' ? 'selected' : ''}>Oui</option>
                       					</select>
                    				</div>
                    				<div class="col-md-5">
                        				<label>Date fin CVI</label>
                        				<input type="date" class="form-control" id="unit-${index}-${i}-dateFinCVI" value="${unit.dateFinCVI || ''}">
                    				</div>
                			</div>
                			<div class="mt-2">
                    				<div id="${qrId}" class="qr-code-img"></div>
						<button class="btn btn-sm btn-danger" onclick="deleteUnit(${index}, ${i})">Supprimer</button>
						<button class="btn btn-sm btn-outline-success" onclick="downloadQRCode('${machine.marque} | ${machine.model} | ${unit.numserie}', 'QR-${unit.numserie}.png', '${machine.marque}', '${machine.model}', '${unit.numserie}')">Télécharger</button>
                			</div>
            			</div>
        		`;
    		}
    		return html;
	}


	function deleteUnit(machineIndex, unitIndex) {
    		const machine = machines[machineIndex];
    		if (!machine.unites || !machine.unites[unitIndex]) return;
		const unit = machine.unites[unitIndex];
    		if (!confirm(`Supprimer l’unité n°${unitIndex + 1} (n° série: ${machine.unites[unitIndex].numserie}) ?`)) return;
		logAction("suppression", `Suppression d’une unité de ${machine.marque} ${machine.model} ${unit.numserie}`, {
    			numserie: unit.numserie
		});
    		machine.unites.splice(unitIndex, 1);
    		machine.quantite = machine.unites.length;

		if (machine.quantite === 0) {
        		machines.splice(machineIndex, 1);
        		showAlert("Machine supprimée car elle n'a plus d'unités", "warning");
			showView('list-machines');
    		}
		logAction("suppression", `Suppression d'une unité de ${machine.marque} ${machine.model}, s/n : ${unit.numserie}`, {
        		numserie: unit.numserie
    		});
		const uniquePositions = [...new Set(machine.unites.map(u => u.position?.trim()).filter(pos => pos))];
    		machine.emplacement = uniquePositions.join(' + ');
    		saveMachines();
    		updateInventory();
    		updateCVIList();
    		showAlert("Unité supprimée avec succès", "success");
	}


	function saveUnitDetails(index) {
    		const machine = machines[index];
    		const newUnits = [];

    		for (let i = 0; i < machine.quantite; i++) {
        		const numserie = document.getElementById(`unit-${index}-${i}-numserie`).value.trim();
	       		const position = document.getElementById(`unit-${index}-${i}-position`).value.trim();
        		const etatcvi = document.getElementById(`unit-${index}-${i}-etatcvi`).value;
        		const dateFinCVI = etatcvi === 'oui' ? document.getElementById(`unit-${index}-${i}-dateFinCVI`).value : null;
        		newUnits.push({ numserie, etatcvi, position, dateFinCVI });
    		}

  		machines[index].unites = newUnits;
		machines[index].quantite = newUnits.length; 

    		if (machines[index].quantite === 0) {
        		machines.splice(index, 1);
        		showAlert("Machine supprimée car elle n'a plus d'unités", "warning");
    		}

		const uniquePositions = [...new Set(newUnits
    			.map(u => u.position?.trim())
    			.filter(pos => pos))];
		machines[index].emplacement = uniquePositions.join(' + ');
		const numseries = importedData.flatMap(m => m.unites?.map(u => u.numserie)).filter(Boolean);
		logAction("import", "Importation JSON", { count: importedData.length, numseries });

    		saveMachines();
		updateInventory();
    		updateCVIList();
		logAction("modification", `Unités n°${unit.numserie} modifiées de ${machine.marque} ${machine.model}`, {
    			numseries
		});
    		showAlert('Unités mises à jour avec succès', 'success');
	}

	function exportData() {
    		const dataStr = JSON.stringify(machines);
    		const blob = new Blob([dataStr], { type: "application/json" });
    		const url = URL.createObjectURL(blob);
    		const a = document.createElement("a");
    		a.href = url;
    		a.download = "machines.json";
    		a.click();
	}

	function importData() {
    		const fileInput = document.getElementById('import-file');
    		const file = fileInput.files[0];
    		if (!file) return;

    	const reader = new FileReader();
    	reader.onload = function(event) {
        	try {
            		const importedData = JSON.parse(event.target.result);
            		if (Array.isArray(importedData)) {
				if (!importedData.every(item => item.marque && item.model && Array.isArray(item.unites))) {
    					showAlert("Structure de données incorrecte", "danger");
    					return;
				}
               			machines = importedData;
				logAction("importation", `Importation d'un fichier JSON`, {
				});
                		saveMachines();
                		showAlert("Données importées avec succès", "success");
                		updateInventory();
            		} else {
                		showAlert("Format de fichier invalide", "danger");
            		}
        	} catch (e) {
            		showAlert("Erreur lors de l'importation", "danger");
        	}
    	};
    	reader.readAsText(file);
	}


	function exportDataToExcel() {
    		const expandedData = [];

    		machines.forEach(machine => {
        		const baseData = {
            			marque: machine.marque,
            			model: machine.model,
            			quantite: machine.quantite,
				description: machine.description,
        		};

        		if (Array.isArray(machine.unites) && machine.unites.length > 0) {
            			machine.unites.forEach(unit => {
                			expandedData.push({
                    				...baseData,
                    				numserie: unit.numserie || '',
						position: unit.position || '',
                    				etatcvi: unit.etatcvi || 'non',
                    				dateFinCVI: unit.dateFinCVI || ''
                			});
            			});
        		} else {
            			expandedData.push({
                			...baseData,
                			numserie: '',
					position: '',
                			etatcvi: 'non',
                			dateFinCVI: ''
            			});
        		}	
    		});

    		const ws = XLSX.utils.json_to_sheet(expandedData);
    		const wb = XLSX.utils.book_new();
    		XLSX.utils.book_append_sheet(wb, ws, "Inventaire");

    		const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    		const blob = new Blob([wbout], { type: "application/octet-stream" });

    		const url = URL.createObjectURL(blob);
    		const a = document.createElement("a");
    		a.href = url;
    		a.download = "inventaire.xlsx";
    		a.click();
	}

	function importDataFromExcel() {
    		const fileInput = document.getElementById('import-excel-file');
    		const file = fileInput.files[0];
    		if (!file) return;

    		const reader = new FileReader();
    		reader.onload = function(event) {
        		const data = new Uint8Array(event.target.result);
        		const workbook = XLSX.read(data, { type: "array" });

        		const firstSheetName = workbook.SheetNames[0];
        		const worksheet = workbook.Sheets[firstSheetName];
        		const importedRows = XLSX.utils.sheet_to_json(worksheet);

        		const grouped = {};

        		importedRows.forEach(row => {
            			const key = `${row.marque}|${row.model}`;
            			if (!grouped[key]) {
                			grouped[key] = {
                    				marque: row.marque,
                    				model: row.model,

                   				quantite: 0,
						description: row.description,
                	    			unites: []
                			};
           			}

            			grouped[key].unites.push({
                			numserie: row.numserie || '',
					position: row.position || '',
                			etatcvi: row.etatcvi || 'non',
               				dateFinCVI: row.etatcvi === 'oui' ? (row.dateFinCVI || null) : null
            			});

            			grouped[key].quantite++;
        		});

       	 		machines = Object.values(grouped).map(machine => ({
            			...machine,
            			etatcvi: 'non',
            			dateFinCVI: null,
            			createdAt: new Date().toISOString()
        		}));
			const numseries = importedRows.map(r => r.numserie).filter(Boolean);
			logAction("import", "Importation Excel", { lignes: importedRows.length, numseries });

        		saveMachines();
        		showAlert("Importation Excel réussie", "success");
        		updateInventory();
    		};

    		reader.readAsArrayBuffer(file);
	}

	let currentMachineIndex = null;
	let currentUnitIndex = null;

	function showUnitEditView(machineIndex, unitIndex) {
    		currentMachineIndex = machineIndex;
    		currentUnitIndex = unitIndex;
		document.getElementById('unit-edit-view').classList.remove('hidden');
		bootstrap.Modal.getInstance(document.getElementById('productModal'))?.hide();

    		const machine = machines[machineIndex];
    		const unit = machine.unites[unitIndex];

    		document.getElementById('edit-unit-marque').value = machine.marque;
    		document.getElementById('edit-unit-modele').value = machine.model;
    		document.getElementById('edit-unit-numserie').value = unit.numserie;
    		document.getElementById('edit-unit-position').value = unit.position;
    		document.getElementById('edit-unit-cvi').value = unit.etatcvi;
    		document.getElementById('edit-unit-date-cvi').value = unit.dateFinCVI || '';
    		document.getElementById('delete-unit-button').onclick = function() {
        		deleteUnit(currentMachineIndex, currentUnitIndex);
    		};

		showView('unit-edit');
	}
	document.getElementById('unit-edit-form').addEventListener('submit', function(e) {
    		e.preventDefault();

    		const machine = machines[currentMachineIndex];
    		const unit = machine.unites[currentUnitIndex];

    		machine.marque = document.getElementById('edit-unit-marque').value;
    		machine.model = document.getElementById('edit-unit-modele').value;
    		unit.numserie = document.getElementById('edit-unit-numserie').value;
    		unit.position = document.getElementById('edit-unit-position').value;
    		unit.etatcvi = document.getElementById('edit-unit-cvi').value;
    		unit.dateFinCVI = (unit.etatcvi === 'oui') ? document.getElementById('edit-unit-date-cvi').value : null;
        	const uniquePositions = [...new Set(machine.unites.map(u => u.position?.trim()).filter(pos => pos))];
	        machine.emplacement = uniquePositions.join(' + ');
    		saveMachines();
		logAction("modification", `Modification de l’unité ${machine.marque} ${machine.model}${unit.numserie}`, {
    			marque: machine.marque,
    			model: machine.model,
    			numserie: unit.numserie
		});
    		showAlert('Unité mise à jour', 'success');
    		showView('scan');
	});

	function downloadQRCode(data, filename = "qr-code.png", marque = "", model = "",numserie="") {
    		const qr = qrcode(0, 'L');
    		qr.addData(data);
    		qr.make();

    		const qrImg = new Image();
    		qrImg.src = qr.createDataURL(10);

    		qrImg.onload = () => {
        		const padding = 10;
        		const fontSize = 28;
        		const lineHeight = fontSize + 4;


        		const canvas = document.createElement("canvas");
        		const width = qrImg.width + 10;
       	 		const height = qrImg.height + padding + (lineHeight * 3); 

        		canvas.width = width;
        		canvas.height = height;

        		const ctx = canvas.getContext("2d");

        		ctx.fillStyle = "#fff";
        		ctx.fillRect(0, 0, canvas.width, canvas.height);

        		ctx.drawImage(qrImg, 0, 0);

        		ctx.fillStyle = "#000";
        		ctx.font = `${fontSize}px Arial`;
        		ctx.textAlign = "center";

        		const centerX = width / 2;
        		const startY = qrImg.height + padding;

        		ctx.fillText(`${marque}`, centerX, startY);
        		ctx.fillText(`${model}`, centerX, startY + lineHeight);
			ctx.fillText(`${numserie}`, centerX, startY + lineHeight*2);


        		const link = document.createElement("a");
        		link.download = filename;
        		link.href = canvas.toDataURL("image/png");
        		link.click();
    		};
	}



	function updateCVIList() {
    		const tbody = document.getElementById('cvi-table-body');
    		tbody.innerHTML = '';

    		let found = false;
    		const today = new Date();
    		today.setHours(0, 0, 0, 0);

    		machines.forEach(machine => {
        		(machine.unites || []).forEach(unit => {
            			if (unit.etatcvi === 'oui' && unit.numserie) {
                			const tr = document.createElement('tr');
                			const dateCVI = unit.dateFinCVI ? new Date(unit.dateFinCVI) : null;

                			const isExpired = dateCVI && dateCVI < today;
                			if (isExpired) {
                    				tr.classList.add('table-danger'); 
                			}

                			tr.innerHTML = `
                    				<td>${machine.marque}</td>
                    				<td>${machine.model}</td>
                    				<td>${unit.numserie}</td>
                    				<td>${unit.position}</td>
                   				<td class="${isExpired ? 'text-danger fw-bold' : ''}">
                        				${unit.dateFinCVI || ''}
                        				${isExpired ? ' (Expiré)' : ''}
                    				</td>
                			`;
                			tbody.appendChild(tr);
                			found = true;
            			}
        		});
    		});

    		if (!found) {
       		 	tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune machine avec CVI</td></tr>';
    		}
	}

          	
        function showProductModal(index) {
            const machine = machines[index];
            currentScanIndex = index;
            
            const modalBody = document.getElementById('product-modal-body');
	    let unitFields = '';
	    (machine.unites || []).forEach((unit, i) => {
		unitFields += `
  			<tr>
    				<td>${i + 1}</td>
    				<td>${unit.numserie || ''}</td>
				<td>${unit.position||''}</td>
    				<td>${unit.etatcvi || 'non'}</td>
    				<td>${unit.dateFinCVI || ''}</td>
				<td><button class="btn btn-primary" onclick="showUnitEditView(${index}, ${i})">Modifier</button></td>


  			</tr>
		`;

	    });
	   const tableWrapper = `
		<h6>Liste des unités</h6>
  		<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd;" class="mt-3">
    			<table class="table table-sm table-hover table-bordered mb-0">
     				<thead class="table-light">
        				<tr>
          					<th>N°</th>
         					<th>Numéro de série</th>
						<th>Emplacement</th>
          					<th>CVI</th>
          					<th>Date fin CVI</th>
						<th>Action</th>

        				</tr>
      				</thead>
      				<tbody>
        				${unitFields}
      				</tbody>
    			</table>
  		</div>
	   `;
	   modalBody.innerHTML = `
        	<div class="mb-3">
            		<label class="form-label">Marque</label>
            		<input type="text" class="form-control" id="modal-marque" value="${machine.marque}">
        	</div>
        	<div class="mb-3">
            		<label class="form-label">Modèle</label>
            		<input type="text" class="form-control" id="modal-model" value="${machine.model}">
        	</div>
		
		<div>
			
			<div class="mb-3">
    				<label class="form-label">Description</label>
    				<textarea class="form-control" id="modal-description" rows="4">${machine.description || ''}</textarea>
    				<div class="form-text mt-1">Aperçu : <span id="description-preview"></span></div>
			</div>
		</div>
        	${tableWrapper}

        	<div class="d-flex justify-content-between mt-3">
            		<button class="btn btn-primary" onclick="updateProduct()">Enregistrer</button>
            		<button class="btn btn-danger" onclick="deleteMachine(${index})">Supprimer</button>
        	</div>
    	   `;
           document.getElementById('description-preview').innerHTML = rendreCliquable(machine.description || "");

            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function updateProduct() {
            const index = currentScanIndex;
	    const newmodel = document.getElementById('modal-model').value;
	    const newmarque = document.getElementById('modal-marque').value;
	    const newdescription = document.getElementById('modal-description').value;


    	    if (!newmarque || !newmodel) {
        		showAlert('Veuillez remplir correctement tous les champs', 'danger');
        		return;
   	    }

            machines[index].model = newmodel;
            machines[index].marque = newmarque;
	    machines[index].description = newdescription;
	    const numseries = machines[index].unites?.map(u => u.numserie).filter(Boolean);
	    logAction("modification", `Mise à jour de ${machines[index].marque} ${machines[index].model}`, {
    		numseries
	    });
            saveMachines();
            updateInventory();
            updateCVIList();
            showAlert('Produit mis à jour', 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        }

        function deleteMachine(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette machine ?')) {
                machines.splice(index, 1);
                saveMachines();
                updateInventory();
                updateCVIList();
		logAction("suppression", `Machine supprimée : ${machines[index].marque} ${machines[index].model}`);
                showAlert('Machine supprimée', 'success');
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            }
        }




    	const startButton = document.getElementById('startButton');
    	const stopButton = document.getElementById('stopButton');
    	const video = document.getElementById('video');
    	const canvas = document.getElementById('canvas');
    	const resultDiv = document.getElementById('result');
    	const context = canvas.getContext('2d');

    	const productInfo = document.getElementById('productInfo');
    	const productId = document.getElementById('productId');
    	const productDesc = document.getElementById('productDesc');
    	const productStatus = document.getElementById('productStatus');

    	let scanning = false;
    	let stream = null;

    	startButton.addEventListener('click', async () => {
      		try {
        		stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        		video.srcObject = stream;
        		video.style.display = 'block';
        		scanning = true;
        		startButton.disabled = true;
        		stopButton.disabled = false;
        		resultDiv.textContent = "Scanner en cours...";
        		requestAnimationFrame(tick);
      		} catch (err) {
        	  alert("Erreur d'accès à la webcam : " + err);
     		}
    	});

    	stopButton.addEventListener('click', () => {
      		scanning = false;
      		if (stream) {
        	stream.getTracks().forEach(track => track.stop());
     		 }
      		video.srcObject = null;
      		video.style.display = 'none';
      		startButton.disabled = false;
      		stopButton.disabled = true;
      		resultDiv.textContent = "Webcam arrêtée";
      		productInfo.hidden = true;
   	});

    	function tick() {
      		if (!scanning) return;

      		if (video.readyState === video.HAVE_ENOUGH_DATA) {
        		canvas.width = video.videoWidth;
        		canvas.height = video.videoHeight;
        		context.drawImage(video, 0, 0, canvas.width, canvas.height);
        		const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        		const code = jsQR(imageData.data, imageData.width, imageData.height, {
        		  inversionAttempts: "dontInvert",
        		});

        		if (code) {
          			scanning = false;
          			stopButton.click(); // Arrêter automatiquement la webcam
          			resultDiv.textContent = "QR Code détecté : " + code.data;
          			searchMachineByQR(code.data); // Appelle la recherche
           			return;

       			 } else {
          			resultDiv.textContent = "Aucun QR code détecté";
        		}
     		 }

      		if (scanning) {
        		requestAnimationFrame(tick);
      		}
    	}

	function rendreCliquable(texte) {
    		const urlRegex = /(https?:\/\/[^\s]+)/g;
    		return texte.replace(urlRegex, function(url) {
        		return `<a href="${url}" target="_blank">${url}</a>`;
    		});
	}


	function searchMachineByQR(data) {
    		const cleanedData = data.trim().toLowerCase();
    		if (cleanedData.includes('|')) {
        		const [marque, model, numserie] = cleanedData.split('|').map(v => v.trim());
        		for (let i = 0; i < machines.length; i++) {
            			const machine = machines[i];
            			for (let j = 0; j < (machine.unites || []).length; j++) {
                			const unit = machine.unites[j];
                			if (machine.marque.toLowerCase() === marque &&
                    				machine.model.toLowerCase() === model &&
                    				unit.numserie && unit.numserie.toLowerCase() === numserie) {
                    				window.currentMachineIndex = i;
                    				window.currentUnitIndex = j;
		    				showUnitEditView(i, j);
                    				showAlert('Machine trouvée', 'success');
                    				return;
                			}
            			}
        		}
			showView('add-machine');
        		document.getElementById('marque').value = marque;
        		document.getElementById('model').value = model;
        		document.getElementById('quantite').value = 1;
        		document.getElementById('quantite').dispatchEvent(new Event('input'));
        
        		if (document.getElementById('numserie-0')) {
            			document.getElementById('numserie-0').value = numserie;
        		}
    		}
    		showAlert('Aucune machine ou unité trouvée avec ce QR Code', 'danger');
	}

	function logAction(type, message, data = null) {
    		const logs = JSON.parse(localStorage.getItem('logs')) || [];
    		logs.push({
        		timestamp: new Date().toISOString(),
        		type,
        		message,
        		data
    		});
    		localStorage.setItem('logs', JSON.stringify(logs));
	}
	function updateLogsView() {
    		const logs = JSON.parse(localStorage.getItem('logs')) || [];
    		const tbody = document.getElementById('logs-table-body');
    		tbody.innerHTML = '';

    		logs.reverse().forEach(log => {
        		const tr = document.createElement('tr');
        		tr.innerHTML = `
            			<td>${new Date(log.timestamp).toLocaleString()}</td>
           			<td><span class="badge bg-${log.type === 'erreur' ? 'danger' : 'info'}">${log.type}</span></td>
            			<td>${log.message}</td>
        		`;
        		tbody.appendChild(tr);
    		});
	}
	function clearLogs() {
    		if (confirm("Effacer tous les logs ?")) {
        		localStorage.removeItem('logs');
        		updateLogsView();
        		showAlert("Logs supprimés", "warning");
    		}
	}
        function manualSearch() {
            const query = document.getElementById('manual-search').value.trim().toLowerCase();
	    const searchType =document.getElementById('search-type').value;
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            if (!query) {
                showAlert('Veuillez entrer un terme de recherche.', 'warning');
                return;
            }
	    let results = []
	    if (searchType === 'model'){ results = machines.map((m, i) => ({ machine: m, index: i })).filter(({ machine }) => (machine.marque && machine.marque.toLowerCase().includes(query)) ||
                    (machine.model && machine.model.toLowerCase().includes(query))
                );
	    } else if (searchType==='numserie') { results = machines.flatMap((machine, index) => { 
		if (!Array.isArray(machine.unites)) return [];
		return machine.unites.filter(unit =>unit.numserie && unit.numserie.toLowerCase().includes(query)).map(unit=> ({machine, index}));
		});
	   }
				
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-warning">Aucun résultat trouvé</div>';
                return;
            }

            let html = `<div class="list-group">`;
            results.forEach(({ machine, index }) => {
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${machine.marque || ''}</strong> - ${machine.model || ''}
                            <br><small>${machine.quantite || 0} unités disponible | Emplacement : ${machine.emplacement || ''}</small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="showProductModal(${index})">Voir plus</button>
                    </div>
                `;
            });
            html += `</div>`;
            resultsContainer.innerHTML = html;
        }

	let currentSort={key:'',asc:true,th:null};

	function sortMachinesby(key,thElement){
		if (currentSort.key === key){
			currentSort.asc=!currentSort.asc;
		} else {
			currentSort = {key,asc:true,th:thElement};
		}
		machines.sort((a,b)=> { 
			let valA=a[key]; 
			let valB=b[key];
			if (typeof valA === 'string') valA=valA.toLowerCase();
			if (typeof valB === 'string') valB=valB.toLowerCase();
			if (valA < valB) return currentSort.asc ? -1 :1;
			if (valA > valB) return currentSort.asc ? 1 :-1;
			return 0;
		});
		document.querySelectorAll("th.chevron").forEach(span => span.textContent='');
		const chevron = currentSort.asc ? ' ▲':' ▼';
		thElement.querySelector(".chevron").textContent = chevron;
		updateInventory();
	}
	function imprimerQRCodeUnite() {
    		const machine = machines[currentMachineIndex];
    		const unit = machine.unites[currentUnitIndex];
    
    		const marque = machine.marque || '';
    		const model = machine.model || '';
    		const numserie = unit.numserie || '';

    		const qrData = `${marque}|${model}|${numserie}`;
    		const qr = qrcode(0, 'H');
    		qr.addData(qrData);
    		qr.make();

    		const qrImg = qr.createImgTag(5);

    		const printWindow = window.open('', '_blank');
    		printWindow.document.write(`
        		<html>
        			<head>
            				<title>QR Code</title>
            					<style>
                					body {
                    						display: flex;
                    						flex-direction: column;
                    						align-items: center;
                    						justify-content: center;
                    						font-family: Arial, sans-serif;
                					}
                					.infos {
                    						margin-top: 10px;
                    						text-align: center;
                    						font-weight: bold;
                					}
            					</style>
        			</head>
        			<body>
            				${qrImg}
            				<div class="infos">
                				<div>${marque}</div>
                				<div>${model}</div>
                				<div>${numserie}</div>
            				</div>
        			</body>
        		</html>
    		`);
    		printWindow.document.close();
    		setTimeout(() => printWindow.print(), 200);
	}

	async function printQRCode() {
    		const marque = document.getElementById('marque').value.trim();
    		const model = document.getElementById('model').value.trim();
    		const quantite = parseInt(document.getElementById('quantite').value);

    		if (!marque || !model || isNaN(quantite)) {
        		showAlert('Veuillez remplir tous les champs avant d\'imprimer', 'danger');
       	 		return;
    		}

    		const printWindow = window.open('', '_blank');
    
    
    		let printContent = `
    		<!DOCTYPE html>
    		<html>
    		<head>
        		<title>Impression QR Codes</title>
        			<style>
            				@page {
                				size: auto;
                				margin: 0;
            				}
            				body {
                				margin: 0;
                				padding: 0;
						font-family:Arial, sans-serif;
                				height: 100vh;
                				display: flex;
                				flex-direction: column;
                				align-items: center;
                				justify-content: center;

            				}
            				.qr-container {
                				width: auto;
                				height: auto;
                				display: flex;
						display: flex;
                				flex-direction: column;
                				align-items: center;
                				justify-content: center;
                				page-break-after: always;
            				}
            				.qr-code {
              	  				width: auto !important;
                				height: auto !important;
						margin : 0 auto
						image-rendering: crisp-edges;
            				}
            				.infos {
                				text-align: center;
                				font-size: auto;
                				margin-top: 0mm;
                				font-weight: bold;
                				width: 100%;
            				}
        			</style>
    		</head></html>
    <body>`;

    for (let i = 0; i < quantite; i++) {
        const numserie = document.getElementById(`numserie-${i}`)?.value.trim() || '';
        const position = document.getElementById(`position-${i}`)?.value.trim() || '';
        
        const qr = qrcode(0, 'H');
        const qrData = `${marque}|${model}|${numserie}`;
        qr.addData(qrData);
        qr.make();
        const qrImg = qr.createImgTag(5); 

        printContent += `
        <div class="qr-container">
            ${qrImg}
            <div class="infos">
                <div>${marque}</div>
		<div>${model}</div>
                <div>${numserie || ''}</div>
            </div>
        </div>`;
    }

    printContent += `
    </body>
    </html>`;

    printWindow.document.write(printContent);
    printWindow.document.close();
    setTimeout(() => {
        printWindow.print();
    },100);
}

        // Helpers
        function toggleCVIDate() {
            document.getElementById('date-cvi-container').style.display = 
                document.getElementById('etatcvi').value === 'oui' ? 'block' : 'none';
        }

        function saveMachines() {
            localStorage.setItem('machines', JSON.stringify(machines));
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.getElementById('alert-placeholder').appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
		async function chargerMachinesDepuisGitHub() {
    			try {
        			const res = await fetch("https://api.github.com/repos/Valentin-roma/inventaire-machines/contents/data/machines.json");
        			const data = await res.json();
        			const json = atob(data.content); 
        			machines = JSON.parse(json);
        			localStorage.setItem('machines', JSON.stringify(machines));
        			console.log("Données chargées depuis GitHub");
    			} catch (e) {
        			showAlert("Erreur lors du chargement GitHub", "danger");
        			machines = JSON.parse(localStorage.getItem('machines')) || [];
    			}
			machines.forEach(machine=>{
				if (Array.isArray(machine.unites)){
					const uniquepositions=[...new Set(machine.unites.map(u => u.position?.trim()).filter(Boolean))];
					machine.emplacement = uniquepositions.join("+");
			
				}
			});
		}

		async function envoyerVersGitHub(machines) {
  			const response = await fetch("https://machine-api-vercel.vercel.app/api/update", {
    			method: "POST",
    			headers: {
      				"Content-Type": "application/json"
    			},
    			body: JSON.stringify({ contentJSON: machines })
  			});
 
  			const result = await response.json();
  			if (response.ok) {
    				console.log("mise à jour réussi sur github");
  			} else {
    				showAlert("Erreur : " + result.message);
  			}
		}


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body></html>
